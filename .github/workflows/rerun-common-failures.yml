name: Smart Rerun ‚Äì Timeout & 500 Only (SampleTest)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Java setup
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 3Ô∏è‚É£ Run initial tests
      - name: Run tests (initial)
        id: initial
        run: mvn test -Denv=qa -Dsuite=smoke
        continue-on-error: true

      # 4Ô∏è‚É£ Debug: list TestNG output (optional)
      - name: List TestNG results
        run: ls -R target/surefire-reports

      # 5Ô∏è‚É£ Analyze failures & build retry suite
      - name: Analyze failures
        id: analyse
        run: |
          RESULTS="target/surefire-reports/testng-results.xml"
          RETRY_SUITE="test-output/retry-suite.xml"

          # Ensure folder exists
          mkdir -p test-output

          echo "<suite name=\"Retry Suite\">" > $RETRY_SUITE
          echo "  <test name=\"Retry Timeout & 500\">" >> $RETRY_SUITE
          echo "    <classes>" >> $RETRY_SUITE

          RETRY_COUNT=0

          # Collect retryable failed tests
          grep '<test-method status="FAIL"' "$RESULTS" > /tmp/failed_lines.txt || true
          while IFS= read -r line; do
            CLASS=$(echo "$line" | sed -n 's/.*class="\([^"]*\)".*/\1/p')
            METHOD=$(echo "$line" | sed -n 's/.*name="\([^"]*\)".*/\1/p')
            MESSAGE=$(echo "$line" | sed -n 's/.*>\(.*\)<\/exception>.*/\1/p')

            if echo "$MESSAGE" | grep -Ei "timeout|HTTP 500|500 Internal Server Error" > /dev/null; then
              RETRY_COUNT=$((RETRY_COUNT+1))
              echo "      <class name=\"$CLASS\">" >> $RETRY_SUITE
              echo "        <methods>" >> $RETRY_SUITE
              echo "          <include name=\"$METHOD\"/>" >> $RETRY_SUITE
              echo "        </methods>" >> $RETRY_SUITE
              echo "      </class>" >> $RETRY_SUITE
            fi
          done < /tmp/failed_lines.txt

          echo "    </classes>" >> $RETRY_SUITE
          echo "  </test>" >> $RETRY_SUITE
          echo "</suite>" >> $RETRY_SUITE

          if [ "$RETRY_COUNT" -gt 0 ]; then
            echo "retry=true" >> $GITHUB_OUTPUT
          else
            echo "retry=false" >> $GITHUB_OUTPUT
          fi

      # 6Ô∏è‚É£ Rerun retryable failures only
      - name: Rerun retryable failures
        if: steps.analyse.outputs.retry == 'true'
        id: rerun
        run: mvn test -DsuiteXmlFile=test-output/retry-suite.xml
        continue-on-error: true

      # 7Ô∏è‚É£ Final Test Summary (syntax-safe using temp file)
      - name: Final Test Summary
        if: always()
        shell: bash
        run: |
          RESULTS="target/surefire-reports/testng-results.xml"
          RETRY_FAILED="target/surefire-reports/testng-failed.xml"

          echo "### üß™ Final Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Table header
          TABLE="| Test | Initial Result | Retryable | Rerun Result |\n"
          TABLE="$TABLE|------|----------------|-----------|--------------|\n"

          # Read all failed test lines safely into a temp file
          grep '<test-method status="FAIL"' "$RESULTS" > /tmp/failed_lines.txt || true

          while IFS= read -r line; do
            CLASS=$(echo "$line" | sed -n 's/.*class="\([^"]*\)".*/\1/p')
            METHOD=$(echo "$line" | sed -n 's/.*name="\([^"]*\)".*/\1/p')
            MESSAGE=$(echo "$line" | sed -n 's/.*>\(.*\)<\/exception>.*/\1/p')

            if echo "$MESSAGE" | grep -Ei "timeout|HTTP 500|500 Internal Server Error" > /dev/null; then
              RETRY="Yes"
              if [ -f "$RETRY_FAILED" ] && grep -q "$METHOD" "$RETRY_FAILED"; then
                RERUN_RESULT="Fail"
              else
                RERUN_RESULT="Pass"
              fi
            else
              RETRY="No"
              RERUN_RESULT="N/A"
            fi

            TABLE="${TABLE}| ${CLASS}.${METHOD} | Fail | ${RETRY} | ${RERUN_RESULT} |\n"
          done < /tmp/failed_lines.txt

          # Append full table
          echo -e "$TABLE" >> $GITHUB_STEP_SUMMARY

          # Overall verdict
          if [ -f "$RETRY_FAILED" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ùå Some retryable tests still failing after rerun" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ All retryable failures passed after rerun" >> $GITHUB_STEP_SUMMARY
