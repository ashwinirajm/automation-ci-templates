name: Smart Rerun â€“ Timeout & 500 Only (SampleTest)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
     
      - uses: actions/checkout@v4

  
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # Run initial tests
      - name: Run tests (initial)
        run: mvn test -Denv=qa -Dsuite=smoke
        continue-on-error: true

      # Analyze failures (based on your test messages)
      - name: Analyze failures & build retry suite
        id: analyse
        run: |
          RESULTS="test-output/testng-results.xml"
          RETRY_SUITE="test-output/retry-suite.xml"

          echo "### ðŸ§ª Failure Analysis (SampleTest)" >> $GITHUB_STEP_SUMMARY

          if [ ! -f "$RESULTS" ]; then
            echo "âœ… No failures detected" >> $GITHUB_STEP_SUMMARY
            echo "retry=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "<suite name=\"Retry Suite\">" > $RETRY_SUITE
          echo "  <test name=\"Retry Timeout & 500\">" >> $RETRY_SUITE
          echo "    <classes>" >> $RETRY_SUITE

          RETRY_COUNT=0

          grep '<test-method status="FAIL"' $RESULTS | while read -r line; do
            CLASS=$(echo "$line" | sed -n 's/.*class="\([^"]*\)".*/\1/p')
            METHOD=$(echo "$line" | sed -n 's/.*name="\([^"]*\)".*/\1/p')
            MESSAGE=$(echo "$line" | sed -n 's/.*>\(.*\)<\/exception>.*/\1/p')

            if echo "$MESSAGE" | grep -Ei "timeout|HTTP 500|500 Internal Server Error"; then
              echo "ðŸ” Retryable: **$CLASS.$METHOD**" >> $GITHUB_STEP_SUMMARY

              echo "      <class name=\"$CLASS\">" >> $RETRY_SUITE
              echo "        <methods>" >> $RETRY_SUITE
              echo "          <include name=\"$METHOD\"/>" >> $RETRY_SUITE
              echo "        </methods>" >> $RETRY_SUITE
              echo "      </class>" >> $RETRY_SUITE

              RETRY_COUNT=$((RETRY_COUNT+1))
            else
              echo "â›” Not retrying: **$CLASS.$METHOD** (Assertion)" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "    </classes>" >> $RETRY_SUITE
          echo "  </test>" >> $RETRY_SUITE
          echo "</suite>" >> $RETRY_SUITE

          if [ "$RETRY_COUNT" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ” Retry-eligible tests: **$RETRY_COUNT**" >> $GITHUB_STEP_SUMMARY
            echo "retry=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No retry-eligible failures found" >> $GITHUB_STEP_SUMMARY
            echo "retry=false" >> $GITHUB_OUTPUT
          fi

      # Rerun retry-eligible tests only
      - name: Rerun retry-eligible tests
        if: steps.analyse.outputs.retry == 'true'
        run: mvn test -DsuiteXmlFile=test-output/retry-suite.xml
        continue-on-error: true

      # Final Result
      - name: Final status
        if: always()
        run: |
          if [ -f test-output/testng-failed.xml ]; then
            echo "âŒ Retryable tests still failing after rerun" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… All retryable failures passed after rerun" >> $GITHUB_STEP_SUMMARY
          fi
