name: TestNG Failure Analysis & Selective Rerun
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Set up Java
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 3️⃣ Run initial tests
      - name: Run tests (initial)
        id: initial
        run: mvn test -Denv=qa -Dsuite=smoke
        continue-on-error: true

      - name: Archive initial TestNG results
        run: |
              mkdir -p test-output
              cp target/surefire-reports/testng-results.xml test-output/testng-results-initial.xml  

      # 4️⃣ Debug TestNG results (optional, can remove later)
      - name: List TestNG reports
        run: |
          ls -R target/surefire-reports
          head -20 target/surefire-reports/testng-results.xml || true

      # 5️⃣ Analyze failures and build retry suite
      - name: Analyze failures
        id: analyse
        run: |
          RESULTS="target/surefire-reports/testng-results.xml"
          RETRY_SUITE="test-output/retry-suite.xml"

          mkdir -p test-output

          echo "<suite name=\"Retry Suite\">" > $RETRY_SUITE
          echo "  <test name=\"Retry Timeout & 500\">" >> $RETRY_SUITE
          echo "    <classes>" >> $RETRY_SUITE

          RETRY_COUNT=0

          # Capture all failed tests from initial run
          grep -E '<test-method status="FAIL"|<testcase.*failure' "$RESULTS" > /tmp/failed_lines.txt || true

          while IFS= read -r line; do
            CLASS=$(echo "$line" | sed -n 's/.*class="\([^"]*\)".*/\1/p')
            METHOD=$(echo "$line" | sed -n 's/.*name="\([^"]*\)".*/\1/p')
            if [ -z "$CLASS" ]; then
              CLASS=$(echo "$line" | sed -n 's/.*classname="\([^"]*\)".*/\1/p')
            fi
            if [ -z "$METHOD" ]; then
              METHOD=$(echo "$line" | sed -n 's/.*name="\([^"]*\)".*/\1/p')
            fi
            MESSAGE=$(echo "$line" | sed -n 's/.*>\(.*\)<\/exception>.*/\1/p')

            if echo "$MESSAGE" | grep -Ei "timeout|HTTP 500|500 Internal Server Error" > /dev/null; then
              RETRY_COUNT=$((RETRY_COUNT+1))
              echo "      <class name=\"$CLASS\">" >> $RETRY_SUITE
              echo "        <methods>" >> $RETRY_SUITE
              echo "          <include name=\"$METHOD\"/>" >> $RETRY_SUITE
              echo "        </methods>" >> $RETRY_SUITE
              echo "      </class>" >> $RETRY_SUITE
            fi
          done < /tmp/failed_lines.txt

          echo "    </classes>" >> $RETRY_SUITE
          echo "  </test>" >> $RETRY_SUITE
          echo "</suite>" >> $RETRY_SUITE

          if [ "$RETRY_COUNT" -gt 0 ]; then
            echo "retry=true" >> $GITHUB_OUTPUT
          else
            echo "retry=false" >> $GITHUB_OUTPUT
          fi

      # 6️⃣ Rerun retryable failures only
      - name: Rerun retryable failures
        if: steps.analyse.outputs.retry == 'true'
        run: mvn test -DsuiteXmlFile=test-output/retry-suite.xml
        continue-on-error: true

      # 7️⃣ Final Test Summary (shows all failed tests, retryable, rerun result)
      - name: Final Test Summary
        if: always()
        run: bash scripts/final-summary.sh
