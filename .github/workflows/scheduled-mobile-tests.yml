name: Mobile Automation â€“ Android & iOS

env:
  ENVIRONMENT: qa
  THREAD_COUNT: 1

# Triggers: manual + scheduled (weekly)
on:
  workflow_dispatch:
  schedule:
    # Runs every Thursday at 14:30 UTC
    - cron: '30 14 * * 4'

jobs:
  android_tests:
    name: Android Tests
    runs-on: [self-hosted, macos]
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set platform-specific environment variables
      - name: Configure Android test parameters
        run: |
          echo "PLATFORM=android" >> $GITHUB_ENV
          echo "SUITE_XML=android_suite.xml" >> $GITHUB_ENV

      # Locate latest Android build artifact
      # (Replace this path with your actual build location)
      - name: Locate Android app
        run: |
          app=$(ls -t ./builds/android/*.apk | head -n 1)
          if [ -z "$app" ]; then
            echo "Android app not found"
            exit 1
          fi
          echo "APP_PATH=$app" >> $GITHUB_ENV

      - name: Run Android tests
        run: |
          mvn clean test \
            -Denvironment=${{ env.ENVIRONMENT }} \
            -Dplatform=${{ env.PLATFORM }} \
            -DsuiteXmlFiles=${{ env.SUITE_XML }} \
            -DthreadCount=${{ env.THREAD_COUNT }}

      - name: Upload Android reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-test-reports
          path: reports/

  ios_tests:
    name: iOS Tests
    runs-on: [self-hosted, macos]
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set platform-specific environment variables
      - name: Configure iOS test parameters
        run: |
          echo "PLATFORM=ios" >> $GITHUB_ENV
          echo "SUITE_XML=ios_suite.xml" >> $GITHUB_ENV

      # Locate latest iOS build artifact
      # (Replace this path with your actual build location)
      - name: Locate iOS app
        run: |
          app=$(ls -dt ./builds/ios/*.app | head -n 1)
          if [ -z "$app" ]; then
            echo "iOS app not found"
            exit 1
          fi
          echo "APP_PATH=$app" >> $GITHUB_ENV

      - name: Run iOS tests
        run: |
          mvn clean test \
            -Denvironment=${{ env.ENVIRONMENT }} \
            -Dplatform=${{ env.PLATFORM }} \
            -DsuiteXmlFiles=${{ env.SUITE_XML }} \
            -DthreadCount=${{ env.THREAD_COUNT }}

      - name: Upload iOS reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-test-reports
          path: reports/
